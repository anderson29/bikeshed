#!/bin/sh -e
#
#    cloud-tunnel - anonymize web traffic by encrypting and tunneling
#                   traffic through a public cloud instance
#
#    Copyright (C) 2010 Dustin Kirkland <kirkland@ubuntu.com>
#
#    Authors:
#        Dustin Kirkland <kirkland@ubuntu.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

PROG=$(basename "$0")
USER="ubuntu"
SOCKS="10800"
#SQUID="3128"
#SSH_OPTS="-f -N -C -D $SOCKS -L $SQUID:localhost:$SQUID"
SSH_OPTS="-f -N -C -D $SOCKS"

error() {
	echo "ERROR: $@" 1>&2
	exit 1
}

case $1 in
	start)	
		instances=$(ec2-describe-instances | grep "^INSTANCE.*running")
		hostname=$(echo "$instances" | awk '{print $4}')
		[ -z "$hostname" ] && error "No running instances found -- try starting a cloud instance"
		gconftool-2 -t string -s /system/proxy/mode "manual"
		gconftool-2 -t string -s /system/proxy/socks_host "localhost"
		gconftool-2 -t string -s /system/proxy/socks_port "$SOCKS"
		exec ssh $SSH_OPTS $USER@$hostname
#		gconftool-2 -t string -s /system/http_proxy/use_http_proxy "true"
#		gconftool-2 -t string -s /system/http_proxy/host "localhost"
#		gconftool-2 -t int -s /system/http_proxy/port "$SQUID"
	;;
	stop)
		gconftool-2 -t string -s /system/proxy/mode "off"
#		gconftool-2 -t string -s /system/http_proxy/use_http_proxy "false"
		# BUG: Ideally, we'd save the pid of the ssh process and kill that here
		pkill -f "ssh $SSH_OPTS $USER@.*amazonaws.com"
	;;
	status)
		if pgrep -f "ssh $SSH_OPTS $USER@.*amazonaws.com" >/dev/null; then
			echo "$PROG: running"
			exit 0
		else
			echo "$PROG: not running"
			exit 1
		fi
	;;
	*)
		error "Unknown parameter"
	;;
esac

exit 0
